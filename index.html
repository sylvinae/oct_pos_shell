<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OCT POS - Pharmacy Management</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      html,
      body,
      #app {
        width: 100%;
        height: 100%;
        overflow: hidden;
      }
      #loading {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-family: system-ui, -apple-system, sans-serif;
        font-size: 18px;
        color: #666;
      }
      #app {
        display: none;
      }
      #app.loaded {
        display: block;
      }
    </style>
  </head>
  <body>
    <div id="loading">Loading OCT POS...</div>
    <iframe id="app" src="https://oct-pharmacy.netlify.app/">
      style="width: 100%; height: 100%; border: none" allow="clipboard-read;
      clipboard-write" ></iframe
    >
    <script type="module" src="/src/main.ts"></script>
    <script>
      const iframe = document.getElementById("app");
      const loading = document.getElementById("loading");
      const frontendUrl = iframe.src;
      let retryCount = 0;
      const maxRetries = 10;

      if (window.__TAURI__) {
        window.__TAURI__.event.listen("update-ready", (event) => {
          console.log("Update ready:", event.payload);
          if (iframe.contentWindow) {
            iframe.contentWindow.postMessage(
              {
                type: "UPDATE_READY",
                version: event.payload,
              },
              "*"
            );
          }
        });
      }

      window.addEventListener("message", async (event) => {
        const allowedOrigins = [
          "http://localhost:5173",
          "https://oct-back-oct-2025.onrender.com",
        ];

        if (!allowedOrigins.includes(event.origin)) return;

        if (event.data.type === "TAURI_CHECK") {
          iframe.contentWindow.postMessage(
            {
              type: "TAURI_AVAILABLE",
              available: !!window.__TAURI__,
            },
            event.origin
          );
        } else if (event.data.type === "TAURI_INVOKE" && window.__TAURI__) {
          try {
            const result = await window.__TAURI__.core.invoke(
              event.data.cmd,
              event.data.args
            );
            iframe.contentWindow.postMessage(
              {
                type: "TAURI_RESPONSE",
                id: event.data.id,
                result,
              },
              event.origin
            );
          } catch (error) {
            iframe.contentWindow.postMessage(
              {
                type: "TAURI_ERROR",
                id: event.data.id,
                error: error.toString(),
              },
              event.origin
            );
          }
        }
      });

      let isConnected = false;

      function checkFrontend() {
        if (isConnected) return;

        fetch(frontendUrl, { cache: "no-cache" })
          .then((response) => {
            if (response.ok && !isConnected) {
              isConnected = true;
              iframe.style.display = "block";
              iframe.onload = () => {
                loading.style.display = "none";
                iframe.classList.add("loaded");
              };
              iframe.onerror = () => {
                isConnected = false;
                loading.textContent = "Error loading application";
                loading.style.color = "#d32f2f";
              };
            }
          })
          .catch(() => {
            if (!isConnected) {
              retryCount++;
              if (retryCount < maxRetries) {
                loading.textContent = `Connecting to server... (${retryCount}/${maxRetries})`;
                setTimeout(checkFrontend, 2000);
              } else {
                loading.textContent = `Cannot connect to server at ${frontendUrl}`;
                loading.style.color = "#d32f2f";
              }
            }
          });
      }

      checkFrontend();

      // Clear persisted Redux data when window is closing
      window.addEventListener("beforeunload", () => {
        try {
          if (iframe.contentWindow) {
            // Try to clear the persist key from the iframe's localStorage
            iframe.contentWindow.postMessage({ type: "CLEAR_PERSIST" }, "*");
          }
        } catch (e) {
          console.error("Failed to clear persist data:", e);
        }
      });
    </script>
  </body>
</html>
